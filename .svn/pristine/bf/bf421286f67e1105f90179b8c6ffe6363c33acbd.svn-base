 var visaCommon = {
     attachChangeEvent: function() {
         $(document).on("change", "input[type='checkbox']", function() {
             var input = $(this).siblings("input")
             var checked = $(this).prop("checked");
             if (input) {
                 if (checked) {
                     $(input).prop("disabled", true);
                     $(this).siblings("label.error").remove();
                 } else {
                     $(input).prop("disabled", false);
                 }
             }
         });
         $(document).on("change", "input[type='radio'][data-tpl-id]", function() {
             var infoArea = $(this).siblings("div.area"),
                 $controlMenu = infoArea.children("div.control-menu"),
                 $counter = infoArea.children("input[type='hidden'][counter]"),
                 templateId = $(this).data("tpl-id"),
                 count = Number.parseInt($counter.val());
             if (count == 0) {
                 var $clone = visaCommon.repeat(templateId, count);
                 $clone.insertBefore($controlMenu);
                 $counter.val(1);
             }
         });
         $(document).on("change", "select[data-show-condition]", function() {

             var $option = $(this).find("option:selected");
             var showAreaId = $option.data("show-area");
             showAreaId=showAreaId&&showAreaId.indexOf("#")>-1?showAreaId:"#"+showAreaId;
             if (showAreaId) {
                 var $showArea = $(showAreaId);
                 $showArea.show(300) && $showArea.siblings("div.area").not($showArea).hide(300);
             } else {
                 $(this).siblings("div.area").hide(300);
             }
         })
         $(document).on("change", "input[type='radio']", function() {
             var infoArea = $(this).siblings("div.area");
             var checked = $(this).prop("checked");
             var isYes = utils.isYes($(this));
             var isShow = utils.isShow($(this));
             if (infoArea.length > 1) { //有多个同级info-area，表示为互斥填写区域
                 if (checked && isYes) {
                     $(infoArea[0]).show(300);
                     $(infoArea[1]).hide();
                 } else {
                     $(infoArea[1]).show(300);
                     $(infoArea[0]).hide();
                 }
             } else if (checked) {
                 isShow ? infoArea.show(300) : infoArea.hide(300);
             }
         });
     },
     attachAddDelEvent: function() {
         $("div.control-menu").each(function(index) {
             var $controlMenu = $(this),
                 $container = $controlMenu.parent(),
                 $counter = $controlMenu.siblings("input[counter]");

             var btns = $(this).children("a"),
                 $addBtn = $(btns[0]),
                 $delBtn = $(btns[1]);

             $controlMenu.on("click", "a", function() {
                 var count = Number.parseInt($counter.val() || 0),
                     expr = "input[type='radio'][data-tpl-id]",
                     templateId = $container.parent().children(expr).data("tpl-id");
                 var $clone = visaCommon.repeat(templateId, count);
                 $clone.hide().insertBefore($controlMenu);
                 $clone.show(300);
                 $counter.val(count + 1);
             });
             $controlMenu.on("click", "a:eq(1)", function() {
                 var count = Number.parseInt($counter.val() || 0);
                 if (count > 1) {
                     $(this).parent().prev().hide(300, function() {
                         $(this).remove();
                         $counter.val(count - 1);
                     });
                 }
             });
         });
     },
     repeat: function(templateId, count) {

         var htmlSource = template(templateId, $(window).data());
         var $clone = $(htmlSource);
         $clone.find("input[type!='radio'],select,textarea").attr("id", function(index, id) {
             return id + "_" + count;
         }).attr("name", function(index, name) {
             return name + "_" + count;
         }).end();
         $clone.find("input[type='radio']").attr("id", function(index, id) {
             if (utils.isYes($(this))) {
                 return id + "Yes_" + count;
             } else if (utils.isNo($(this))) {
                 return id + "No_" + count;
             }
             return id;
         }).attr("name", function(index, name) {
             if (utils.isYes($(this))) {
                 return name + "_" + count;
             } else if (utils.isNo($(this))) {
                 return name + "_" + count;
             }
             return name;
         }).end();
         return $clone;

     },
     render: function(bindId, data) {
         var html = template(bindId, $(window).data());
         return html;
     },
     renderSelect: function(settings, listOptions) {
         var selectSource =
             "<select id=\"{{id}}\" name=\"{{name}}\" title=\"{{title}}\" {{conditioned && 'data-show-condition'}} {{if required}} required {{/if}}>" +
             "<option value>--请选择--</option>" +
             "{{each list as op index}}" +
             "  {{if  defaultValue==op.value }}" +
             "    <option value=\"{{op.value}}\"  data-show-area='{{op.showArea}}' selected=\"selected\">{{op.text}}</option>" +
             "  {{else}}" +
             "     <option value=\"{{op.value}}\" data-show-area='{{op.showArea}}' >{{op.text}}</option>" +
             "    {{/if}}" +
             "{{/each}}" +
             "</select>";
         settings.list = listOptions;
         var render = template.compile(selectSource);
         return render(settings);
     }
 }

 template.helper("select", function(listOptions, settings) {
     return visaCommon.renderSelect(settings, listOptions);
 });
 template.helper("join",function(array){
   return array.join(",");
 })

 var utils = {
     isYes: function(e) {
         return $(e).val().toUpperCase() == "Y" || $(e).val() == "1";
     },
     isNo: function(e) {
         return $(e).val().toUpperCase() == "N" || $(e).val() == "0";
     },
     hasTemplate: function(e) {
         return $(e).data("tpl-id") != undefined && $(e).data("tpl-id") != "";
     },
     isShow: function(e) {
         var showVal = $(e).data("is-show");
         var isYes = utils.isYes($(e));
         var isNo = utils.isNo($(e));
         if (showVal != undefined) {
             return showVal.toUpperCase() == "Y" || showVal == "0";
         }
         if (isYes) {
             return true;
         }
         if (isNo) {
             return false;
         }
         return false;
     },
     getQuery: function(q, url) {
         if (!url) url = window.location + '';
         else url += '';
         var reg = new RegExp("[#?&](" + q + ")=([^&]+)", "i");
         var re = reg.exec(url);
         if (re) return unescape(re[2]);
         else return "";
     }
 };

 function VisaFormHelper(options) {
     this.settings = $.extend(true, {}, VisaFormHelper.defaults, options);
 }
 VisaFormHelper.defaults = {
     visaForm: "#visa-form",
     postUrl: "collect",
     loadDataUrl: "http://localhost:9615/us_form.json",
     saveBtn: "#saveBtn",
     nextBtn: "#nextBtn",
     preBtn: "#preBtn",
     checkBtn: "#checkBtn",
     saveTipMessage: "您即将离开此填写页面，是否要保存当前页面数据？",
     validateOptions: {}
 }

 VisaFormHelper.prototype = {
     init: function() {

         var formId = utils.getQuery("formId");
         formId && $("#para-form-id").val(formId);
         var operation = utils.getQuery("op");
         operation && $("#para-op").val(operation);
         this.data = {};
         this.nextUrl = $(this.settings.nextBtn).data("next-url");
         this.preUrl = $(this.settings.preBtn).data("pre-url");
         this.validator = $(this.settings.visaForm).validate(this.settings.validateOptions);
         this.basePara = {
             country: $("#para-country").val(),
             op: $("#para-op").val(),
             formId: $("#para-form-id").val(),
             serialNum: $("#para-form-num").val(),
             progress: $("#para-progress").val()
         }
     },
     bindEvents: function() {
         var _self = this;
         $(this.settings.saveBtn).click(function() {
             _self.save();
         })
         $(this.settings.nextBtn) && $(this.settings.nextBtn).click(function() {
             _self.goNext();
         })
         $(this.settings.preBtn) && $(this.settings.preBtn).click(function() {
             _self.goPre();
         })
     },
     fullChecked: function() {
         return this.validator.form();
     },
     loadFormData: function(formId) {
         var _self = this;
         var result = { success: false, code: "-1", data: {}, message: null };
         var formId = formId || this.basePara.formId;
         $.ajax({
             type: "GET",
             url: this.settings.loadDataUrl,
             data: null, //"formId=" + formId + "&time=" + new Date().toTimeString(),
             dataType: "JSON",
             async: false,
             success: function(response) {

                 _self.data = response;
                 $(window).data("form", response);
                 return;
                 $.extend(result, response);
                 if (result.success) {
                     _self.data = $.parseJSON(result.data);

                     $(window).data("form", _self.data);
                 } else {
                     alert("获取签证资料表单数据错误！");
                 }
             }
         });
     },
     submit: function() {
         var _self = this;
         if (!_self.fullChecked()) {
             alert("页面数据填写未校验通过，请根据提示完善信息！");
             return null;
         }
         var formData = $(_self.settings.visaForm).serialize();
         var result = { success: false, code: "-1", data: { formId: 0 }, message: null };
         $.ajax({
             type: "POST",
             url: _self.settings.postUrl,
             data: formData,
             async: false,
             success: function(response) {
                 $.extend(result, $.parseJSON(response));
                 if (result.success) {}
             }
         })
         return result;
     },
     save: function() {
         var result = this.submit();
         if (!result) return;
         if (result.success) {
             if (this.isAddAction()) { //添加操作成功后修改基础参数
                 $("#para-op").val("update");
                 $("#para-form-id").val(result.data.formId);
                 this.basePara.op = "update";
                 this.basePara.formId = result.data.formId;
             }
             alert("保存成功！");
         } else {
             alert("当前页面数据保存失败！");
         }
     },
     goPre: function() {
         var result = this.submit();
         if (!result) return;
         if (result.success) {
             history.go(-1);
         } else {
             alert("当前页面数据保存失败，无法进入上一步！");
         }
     },
     goNext: function() {
         var result = this.submit();
         if (!result) return;
         if (result.success) {
             location.href = this.nextUrl + "?formId=" + (result.data.formId || this.basePara.formId);
         } else {
             alert("当前页面数据保存失败，无法进入下一步！");
         }
     },
     onSwitchTab: function() {
         var tabUrl = $(this).data("tab-url");
         if (confirm(this.settings.saveTipMessage)) {
             var result = this.submit();
             if (!result) return;
             if (result.success) {
                 location.href = this.tabUrl + "?formId=" + formId;
             } else {
                 alert("当前页面数据保存失败，无法切换页面！");
             }
         }
     },
     completeCheck: function() {

     },
     isAddAction: function() {
         return this.basePara.op && this.basePara.op == "add";
     },
     isUpdateAction: function() {
         return this.basePara.op && this.basePara.op == "update" && this.basePara.formId;
     },
     isNew: function() {
         return this.basePara.op && this.basePara.op == "new" && this.basePara.formId;
     },
     havaPreSetp: function() {
         return $(this.settings.preBtn) && $(this.settings.preBtn).length == 1;
     },
     havaNextStep: function() {
         return $(this.settings.nextBtn) && $(this.settings.nextBtn).length == 1;
     }
 };
 (function() {
     $(document).ready(function() {
         visaCommon.attachChangeEvent();
         visaCommon.attachAddDelEvent();
         //动态加入验证函数
         $.validator.addMethod("phone", function(value) {
             return /^[\d]+$/.test(value);
         }, '请输入正确的电话号码');
         $.validator.addMethod("idCardNum", function(value) {
             return /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(value);
         }, '请输入正确的身份证号');
         $.validator.addMethod("passport", function(value) {
             return /(^1[45][0-9]{7}|G[0-9]{8}|P[0-9]{7}|S[0-9]{7,8}|D[0-9]+$)/.test(value);
         }, '请输入正确的护照号');
         $.validator.addMethod("english", function(value) {
             return /^([A-Za-z]+(\s)?[A-Za-z]+)+$/.test(value);
         }, '请输入英文,单词之间空格不能多于1个!');

         $.validator.addClassRules("passport", {
             required: true,
             passport: true
         });
         $.validator.addClassRules("english", {
             required: true,
             english: true
         });
         $.validator.addClassRules("phone", {
             required: true,
             phone: true
         });
         $.validator.addClassRules("address", {
             required: true,
             maxlength: 88
         });

     })
 })();